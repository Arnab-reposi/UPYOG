serviceMaps:
  serviceName: property-services
  mappings:
  - version: 1.0
    description: Persists assessment details to eg_pt_asmt_assessment table
    fromTopic: save-pt-assessment
    isTransaction: true
    queryMaps:

    - query: INSERT INTO eg_pt_asmt_assessment(id, tenantid, assessmentnumber, financialyear, propertyid, status, source, channel, assessmentdate, additionaldetails, createdby, createdtime, lastmodifiedby, lastmodifiedtime) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
      basePath: Assessments
      jsonMaps:

      - jsonPath: $.Assessments.id

      - jsonPath: $.Assessments.tenantId

      - jsonPath: $.Assessments.assessmentNumber

      - jsonPath: $.Assessments.financialYear

      - jsonPath: $.Assessments.propertyId

      - jsonPath: $.Assessments.status

      - jsonPath: $.Assessments.source

      - jsonPath: $.Assessments.channel

      - jsonPath: $.Assessments.assessmentDate

      - jsonPath: $.Assessments.additionalDetails
        type: JSON
        dbType: JSONB

      - jsonPath: $.Assessments.auditDetails.createdBy

      - jsonPath: $.Assessments.auditDetails.lastModifiedBy

      - jsonPath: $.Assessments.auditDetails.createdTime

      - jsonPath: $.Assessments.auditDetails.lastModifiedTime



    - query: INSERT INTO eg_pt_asmt_unitusage (tenantid, id, assessmentid, unitid, usagecategory, occupancytype, occupancydate, active, createdby, createdtime, lastmodifiedby, lastmodifiedtime) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
      basePath: Assessment.units.*
      jsonMaps:

      - jsonPath: $.Assessments.unitUsageList.*.tenantId

      - jsonPath: $.Assessments.unitUsageList.*.id

      - jsonPath: $.Assessments.[*][?({id} in @.unitUsageList[*].id)].assessmentNumber

      - jsonPath: $.Assessments.unitUsageList.*.unitid

      - jsonPath: $.Assessments.unitUsageList.*.usageCategory

      - jsonPath: $.Assessments.unitUsageList.*.occupancyType

      - jsonPath: $.Assessments.unitUsageList.*.occupancyDate

      - jsonPath: $.Assessments.unitUsageList.*.active

      - jsonPath: $.Assessments.unitUsageList.*.auditDetails.createdBy

      - jsonPath: $.Assessments.unitUsageList.*.auditDetails.createdTime

      - jsonPath: $.Assessments.unitUsageList.*.auditDetails.lastModifiedBy

      - jsonPath: $.Assessments.unitUsageList.*.auditDetails.lastModifiedTime



    - query: INSERT INTO eg_pt_asmt_document (id, tenantid, entityid, documenttype, filestoreid, documentuid, status, createdby, lastmodifiedby, createdtime, lastmodifiedtime) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
      basePath: $.Assessments.documents.*
      jsonMaps:

      - jsonPath: $.Assessments.documents.*.id

      - jsonPath: $.Assessments.tenantId

      - jsonPath: $.Assessments.id

      - jsonPath: $.Assessments.documents.*.documentType

      - jsonPath: $.Assessments.documents.*.fileStoreId

      - jsonPath: $.Assessments.documents.*.documentUid

      - jsonPath: $.Assessments.documents.*.status

      - jsonPath: $.Assessments.documents.*.auditDetails.createdBy

      - jsonPath: $.Assessments.documents.*.auditDetails.lastModifiedBy

      - jsonPath: $.Assessments.documents.*.auditDetails.createdTime

      - jsonPath: $.Assessments.documents.*.auditDetails.lastModifiedTime
      
      
      
  - version: 1.0
    description: Updates assessment details to eg_pt_asmt_assessment table
    fromTopic: update-pt-assessment
    isTransaction: true
    queryMaps:

    - query: INSERT INTO eg_pt_asmt_assessment_audit SELECT *, (SELECT extract(epoch from now())) FROM eg_pt_asmt_assessment WHERE id = ?;
      basePath: Assessment
      jsonMaps:

      - jsonPath: $.Assessments.id
      
      
    - query: INSERT INTO eg_pt_asmt_unitusage_audit SELECT *, (SELECT extract(epoch from now())) FROM eg_pt_unit WHERE id = ?;
      basePath: Assessment.units.*
      jsonMaps:

      - jsonPath: $.Assessments.unitUsageList.*.id
      
      
    - query: UPDATE eg_pt_asmt_assessment SET financialyear = ?, status = ?, source = ?, assessmentDate = ?, additionaldetails = ?, lastmodifiedby = ?, lastmodifiedtime = ? WHERE id = ?;
      basePath: Assessment
      jsonMaps:

      - jsonPath: $.Assessments.financialYear

      - jsonPath: $.Assessments.status

      - jsonPath: $.Assessments.source

      - jsonPath: $.Assessments.assessmentDate

      - jsonPath: $.Assessments.additionalDetails
        type: JSON
        dbType: JSONB

      - jsonPath: $.Assessments.auditDetails.lastModifiedBy

      - jsonPath: $.Assessments.auditDetails.lastModifiedTime
      
      - jsonPath: $.Assessments.id




    - query: INSERT INTO eg_pt_asmt_unitusage (tenantid, id, assessmentId,  usageCategory, occupancyType, occupancyDate, active, createdby, createdtime, lastmodifiedby, lastmodifiedtime) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) ON CONFLICT (id) DO UPDATE  usageCategory = ?, occupancyType = ?, occupancyDate = ?, active = ?, lastmodifiedby = ?, lastmodifiedtime = ?;
      basePath: Assessment.units.*
      jsonMaps:

      - jsonPath: $.Assessments.unitUsageList.*.tenantId

      - jsonPath: $.Assessments.unitUsageList.*.id

      - jsonPath: $.Assessments.[*][?({id} in @.unitUsageList[*].id)].assessmentNumber

      - jsonPath: $.Assessments.unitUsageList.*.usageCategory

      - jsonPath: $.Assessments.unitUsageList.*.occupancyType

      - jsonPath: $.Assessments.unitUsageList.*.occupancyDate

      - jsonPath: $.Assessments.unitUsageList.*.active

      - jsonPath: $.Assessments.unitUsageList.*.auditDetails.createdBy

      - jsonPath: $.Assessments.unitUsageList.*.auditDetails.createdTime

      - jsonPath: $.Assessments.unitUsageList.*.auditDetails.lastModifiedBy

      - jsonPath: $.Assessments.unitUsageList.*.auditDetails.lastModifiedTime

      - jsonPath: $.Assessments.unitUsageList.*.usageCategory

      - jsonPath: $.Assessments.unitUsageList.*.occupancyType

      - jsonPath: $.Assessments.unitUsageList.*.occupancyDate

      - jsonPath: $.Assessments.unitUsageList.*.active

      - jsonPath: $.Assessments.unitUsageList.*.auditDetails.lastModifiedBy

      - jsonPath: $.Assessments.unitUsageList.*.auditDetails.lastModifiedTime




    - query: INSERT INTO eg_pt_asmt_document (id, tenantid, entityid, documenttype, filestoreid, documentuid, status, createdby, lastmodifiedby, createdtime, lastmodifiedtime) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?) ON CONFLICT (id) DO UPDATE documenttype = ?, documentuid = ?, status = ?, lastmodifiedby = ?, lastmodifiedtime = ?;
      basePath: $.Assessments.documents.*
      jsonMaps:

      - jsonPath: $.Assessments.documents.*.id

      - jsonPath: $.Assessments.documents.*.tenantId

      - jsonPath: $.Assessments.id

      - jsonPath: $.Assessments.documents.*.documentType

      - jsonPath: $.Assessments.documents.*.fileStoreId

      - jsonPath: $.Assessments.documents.*.documentUid

      - jsonPath: $.Assessments.documents.*.status

      - jsonPath: $.Assessments.documents.*.auditDetails.createdBy

      - jsonPath: $.Assessments.documents.*.auditDetails.lastModifiedBy

      - jsonPath: $.Assessments.documents.*.auditDetails.createdTime

      - jsonPath: $.Assessments.documents.*.auditDetails.lastModifiedTime
      
      - jsonPath: $.Assessments.documents.*.documentType

      - jsonPath: $.Assessments.documents.*.documentUid

      - jsonPath: $.Assessments.documents.*.status

      - jsonPath: $.Assessments.documents.*.auditDetails.lastModifiedBy

      - jsonPath: $.Assessments.documents.*.auditDetails.lastModifiedTime
      
      
      
      